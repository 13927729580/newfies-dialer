{% extends "frontend/master.html" %}
{% load i18n common_tags %}

{% block title %}
    {% trans 'Dashboard' %}
{% endblock %}

{% block extra_header %}
    {% include "frontend/flotr_humble_header.html" %}
{% endblock %}

{% block content_header %}
    <h1>{% trans "Dashboard" %} <small>{% trans "Realtime campaign performance monitoring" %}</small></h1>
{% endblock %}

{% block content %}
<div id="label" align="center">

<form class="well form-inline" method="POST" action="." id="id_searchform" name="searchform" enctype="multipart/form-data">{% csrf_token %}
<p align="center">
    {{ form.campaign }} {{ form.search_type }}
    <input type="submit" class="btn primary" name="submit" value="{% trans "Submit" %}">
</p>

<table align="center" class="table table-striped table-bordered table-condensed">
    <thead>
    <tr>
        <th>{% trans "Campaign" %}</th>
        <th>{% trans "Total Phonebook Contacts" %}</th>
        <th>{% trans "Total Campaign Contacts" %}</th>
        <th>{% trans "Contacted Today" %}</th>
    </tr>
    </thead>
    <tr>
        <td class="rounded-foot-left">{{ campaign_count }}</td>
        <td>{{ total_of_phonebook_contacts }}</td>
        <td>{{ campaign_phonebbok_active_contact_count }}</td>
        <td class="rounded-foot-right">{{ reached_contact }}</td>
    </tr>
</table>

<script type="text/javascript">
    var jsonData = [
        {% for td in total_data %}
           {date:'{{ td.date }}', year:{{ td.year }},day:{{ td.day }}, month:{{ td.month }}, calls:{{ td.starting_date__count }}, duration:'{{ td.duration__sum|conv_min }}', act:'{{ td.duration__avg|conv_min }}'},
        {% endfor %}
    ];

    var callData = [
        {% for td in total_data %}
            [{{ td.count }} , {{ td.starting_date__count }}],
        {% endfor %}
    ];

    var durationData = [
        {% for td in total_data %}
            [{{ td.count }} , {{ td.duration__sum }}],
        {% endfor %}
    ];

    var summaryData = [
        {% for td in total_data %}
            [{{ td.count }} , {{ td.starting_date__count }}],
        {% endfor %}
    ];
</script>

<script type="text/javascript">
(function($){
    Event.observe(document, 'dom:loaded', function() {
        prettyPrint();
        HumbleFinance.trackFormatter = function (obj) {
            var x = Math.floor(obj.x);
            var data = jsonData[x];
            var text = data.date + " {% trans "Calls :" %} " + data.calls + " {% trans "Duration :" %} " + data.duration + " {% trans "ACT :" %} " + data.act;
            return text;
        };
        HumbleFinance.yTickFormatter = function (n) {
            if (n == this.axes.y.max) {
                return false;
            }
            return n;
        };
        HumbleFinance.xTickFormatter = function (n) {
            if (n == 0) {
                return false;
            }
            x = Math.floor(n)
            var data = jsonData[x].day;
            return data;
        };
        {% if select_graph_for == 'Call Count' %}
            HumbleFinance.init('finance', callData, durationData, summaryData);
        {% else %}
            HumbleFinance.init('finance', durationData, callData, summaryData);
        {% endif %}
      });
})(jQuery);
</script>

<input type="submit" class="btn" value="{% trans "Call Count" %}" name="call_count_button"/> &nbsp; &nbsp;
<input type="submit" class="btn btn-info" value="{% trans "Duration" %}" name="duration_button"/>
</form>

</div>

{% if total_data %}
<div class="row">
    <div class="span12">
    <div id="finance">
        <div id="labels">
            <div id="financeTitle"></div>
            <div id="dateRange"></div>
        </div>
    </div>
    </div>
</div>
{% endif %}
<script id="source" language="javascript" type="text/javascript">
    (function($){
        var data = [
            {% for data in total_record %}
                [{{ data.0 }}, {{ data.1.count_call }}, {{ data.1.duration_sum }}],
            {% endfor %}
        ];

        //for (var i = 0; i < data.length; ++i)
        //    data[i][0] += 60 * 60 * 1000;

        function Info(time,info){
            for(var i in data){
                if(data[i][0] == parseInt(time)){
                    switch(info){
                        case 0:
                            return data[i][0];
                            break;
                        case 1:
                            return data[i][1];
                            break;
                        case 2:
                            return data[i][2];
                            break;
                        default:
                            return data[i][0];
                    }
                }
            }
        }

        function formTicks(val) {

            var dt = new Date(parseInt(val));
            var hour = dt.getHours();
            var minute = dt.getMinutes();
            var ampm = hour >= 12 ? 'pm' : 'am';
            var hour = hour % 12;
            hour = hour ? hour : 12; // the hour '0' should be '12'
            minute = minute < 10 ? '0' + minute : minute;
            strTime = hour + ':' + minute + ' ' + ampm;
            return strTime
        }

        var options = {
            xaxis: { mode: "time",
                tickLength: 5,
                tickFormatter: function(val) { return formTicks(val) }
            },
            yaxis: { min: 0, tickDecimals: false },
            selection: { mode: "x" },
            grid: {
                hoverable: true,
                xaxis: false
            }
        };

        var plot = $.plot($("#graph_responsive"), [data], options);

        var overview = $.plot($("#overview"), [data], {
            legend: {show: false},
            series: {
                lines: { show: true, lineWidth: 1 },
                shadowSize: 0
            },
            xaxis: { ticks: [], mode: "time" },
            yaxis: { ticks: [], min: 0, autoscaleMargin: 0.1 },
            selection: { mode: "x" }
        });

        // now connect the two
        $("#graph_responsive").bind("plotselected", function (event, ranges) {
            // do the zooming
            plot = $.plot($("#graph_responsive"), [data],
                    $.extend(true, {}, options, {
                        xaxis: { min: ranges.xaxis.from, max: ranges.xaxis.to }
                    }));

            // don't fire event on the overview to prevent eternal loop
            overview.setSelection(ranges, true);
        });

        $("#overview").bind("plotselected", function (event, ranges) {
            plot.setSelection(ranges);
        });

        $("#graph_responsive").bind("plothover", function (event, pos, item) {
            if (item) {
                if (previousPoint != item.dataIndex) {
                    previousPoint = item.dataIndex;

                    $("#tooltip").remove();
                    var x = item.datapoint[0].toFixed(2),
                            y = item.datapoint[1].toFixed(2);

                    var time = x;
                    var dt = new Date(parseInt(time));
                    var hour = dt.getHours();//(time.toString().split("."))[0];
                    var minute = dt.getMinutes();//Math.round(time * 60 - (hour * 60));
                    var output = '';
                    output += '<div class="graph_tooltip_header">';

                    var ampm = hour >= 12 ? 'pm' : 'am';
                    var hour = hour % 12;
                    hour = hour ? hour : 12; // the hour '0' should be '12'
                    minute = minute < 10 ? '0'+minute : minute;
                    strTime = hour + ':' + minute + ' ' + ampm;

                    output += strTime + '</div><div class="graph_tooltip_info">{% trans "Calls" %}: ' + Info(time,1) + '<br>{% trans "Duration" %}: ' + Info(time,2) + ' {% trans "secs" %}</div>';

                    showTooltip(item.pageX, item.pageY, output);
                }
            }
            else {
                $("#tooltip").remove();
                previousPoint = null;
            }
        });
    })(jQuery);
</script>

<div class="row">
    <div class="span12">
        <div id="graph_responsive" style="margin:auto;"></div>
    </div>
</div>
<div class="row">
    <div class="span12">
        <div id="overview" style="margin:auto;margin-bottom:20px;margin-top:20px;width:400px;height:50px"></div>
    </div>
</div>
<br/><br/>

{% if final_calls %}

    <script type="text/javascript">
    function pieHover(event, pos, obj)
    {
        if (!obj)
            return;
        percent = parseFloat(obj.series.percent).toFixed(2);
        (function($){
            $("#hover").html('<span style="font-weight: bold; color: '+obj.series.color+'">'+obj.series.label+' ('+percent+'%)</span>');
        })(jQuery);
    }

    function pieClick(event, pos, obj)
    {
        if (!obj)
            return;
        percent = parseFloat(obj.series.percent).toFixed(2);
        alert(''+obj.series.label+': '+percent+'%');
    }
    (function($){
        $(function () {

            var data = [
                { label: 'ANSWER' , data: [[1, {{ total_answered }}]], color: '{{ answered_color }}' },
                { label: 'BUSY' , data: [[1, {{ total_busy }}]], color: '{{ busy_color }}' },
                { label: 'NOANSWER' , data: [[1, {{ total_not_answered }}]], color: '{{ not_answered_color }}' },
                //{ label: 'OHTERS' , data: [[1, {{ total_others }}]]},
                { label: 'CANCEL' , data: [[1, {{ total_cancel }}]], color: '{{ cancel_color }}' },
                { label: 'CONGESTION' , data: [[1, {{ total_congestion }}]], color: '{{ congestion_color }}' },
                { label: 'CHANUNAVAIL' , data: [[1, {{ total_chanunavail }}]], color: '{{ chanunavail_color }}' },
                { label: 'DONTCALL' , data: [[1, {{ total_dontcall }}]], color: '{{ dontcall_color }}' },
                { label: 'TORTURE' , data: [[1, {{ total_torture }}]], color: '{{ torture_color }}' },
                { label: 'INVALIDARGS' , data: [[1, {{ total_invalidargs }}]], color: '{{ invalidargs_color }}' },
                { label: 'NOROUTE' , data: [[1, {{ total_noroute }}]], color: '{{ noroute_color }}' },
                { label: 'FORBIDDEN' , data: [[1, {{ total_forbidden }}]], color: '{{ forbidden_color }}' },
            ];
            var options = {
                    series: {
                        pie: {
                            show: true,
                            radius: 1,
                            label: {
                                show: true,
                                radius: 3/4,
                                formatter: function(label, series){
                                    return '<div style="font-size:8pt;text-align:center;padding:2px;color:white;">'+label+'<br/>'+Math.round(series.percent)+'%</div>';
                                    }
                                },
                            background: { opacity: 0.5 },
                        }
                    },
                    legend: {
                        show: false,
                    },
                    grid: {
                        hoverable: true,
                        clickable: true
                    },
            };
            $("#camp_pie").bind("plothover", pieHover);
            $("#camp_pie").bind("plotclick", pieClick);
            var plot = $.plot($("#camp_pie"), data, options);
        });

    })(jQuery);
</script>

<div class="row">
    <div class="span12">
        <div class="row">
            <div class="span6">
                <div id="camp_pie" style="width:300px;height:270px;float:left;margin: 0px 50px 50px 50px;"></div>
            </div>

            <div class="span6">
                <table style="width: 400px; margin: 50px 0px 0px 0px; background-color: #e6f7fe;" class="bordered-table">
                <tr>
                    <th style="color: #111111; width: 120px;" colspan="3">{{ total_call_count }}  {% trans "TOTAL CALLS" %}</th>
                </tr>
                <tr>
                    <th style="color: {{ answered_color }}">{{ total_answered }}  {% trans "ANSWERED" %}</th>
                    <th style="color: {{ dontcall_color }}">{{ total_dontcall }}  {% trans "DONTCALL" %}</th>
                    <th style="color: {{ busy_color }}">{{ total_busy }}  {% trans "BUSY" %}</th>
                </tr>
                <tr>
                    <th style="color: {{ chanunavail_color }}">{{ total_chanunavail }}  {% trans "CHANUNAVAIL" %}</th>
                    <th style="color: {{ torture_color }}">{{ total_torture }}  {% trans "TORTURE" %}</th>
                    <th style="color: {{ not_answered_color }}">{{ total_not_answered }}  {% trans "NOANSWER" %}</th>
                </tr>
                <tr>
                    <th style="color: {{ invalidargs_color }}">{{ total_invalidargs }}  {% trans "INVALIDARGS" %}</th>
                    <th style="color: {{ cancel_color }}">{{ total_cancel }}  {% trans "CANCEL" %}</th>
                    <th style="color: {{ noroute_color }}">{{ total_noroute }}  {% trans "NOROUTE" %}</th>
                </tr>
                <tr>
                    <th style="color: {{ congestion_color }}">{{ total_congestion }}  {% trans "CONGESTION" %}</th>
                    <th style="color: {{ forbidden_color }}">{{ total_forbidden }}  {% trans "FORBIDDEN" %}</th>
                    <th>&nbsp;</th>
                </tr>
                </table>

                <div id="hover" style="float: left;"><span style="font-weight: bold; color: rgb(148, 64, 237);"></span>
                </div>
            </div>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}
