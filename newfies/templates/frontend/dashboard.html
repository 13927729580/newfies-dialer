{% extends "frontend/master.html" %}
{% load dialer_cdr_extras icons i18n %}

{% block title %}
{% trans 'Dashboard' %}
{% endblock %}

{% block extra_header %}
    {% include "frontend/flotr_humble_header.html" %}
    <script type="text/javascript">
      //jQuery.noConflict(); // To resolve conflict with jquery & prototype
      //(function($){ // jquey function call in (function($){})(jQuery);
          $(document).ready(function() {
            $(".fg-button").hover(
                function(){
                    $(this).addClass("ui-state-hover");
                },
                function(){
                    $(this).removeClass("ui-state-hover");
                }
            );
            $('#buttonlogin').click(function(){
              $("#requestlogin").animate({ height: 'show', opacity: 'show' }, 'slow');
            });
            $('#buttonlogout').click(function(){
              $('#logout').submit();
            });
            $('#buttonadmin').click(function(){
                var url = String(window.location);
                var patt = "(https?|ftp|gopher|telnet|file|notes|ms-help)://[^/]+/";
                window.location = url.match(patt)[0] + 'admin';
            });
            $("#language-container").change(function() {
                this.form.submit();
            });
          });
      //})(jQuery);
    </script>
{% endblock %}



{% block content %}
<form method="POST" action="." enctype="multipart/form-data">{% csrf_token %}
<p>{{ form.campaign.label }} {{ form.campaign }} {{ form.search_type }}
<input type="submit" name="submit" value="Submit">
</p>
<P>
    {% for j in total_data %}
       {{ j }}<br/>
    {% endfor %}
    {% for i in final_calls %}
        <!--{{ i }}<br/>-->
    {% endfor %}
</P>
</form>
    <!--
<table align="center" id="rounded-corner">
        <thead>
        <tr>
            <th class="rounded-company">Running Campaign</th>
            <th class="rounded-q1">Total Phonebook Contacts</th>
            <th class="rounded-q2">Total Campaign Contacts</th>
            <th class="rounded-q4">Contacted Today</th>
        </tr>
        </thead>
        <tr>
            <td class="rounded-foot-left">{{ running_campaign_count }}</td>
            <td>{{ total_of_phonebook_contacts }}</td>
            <td>{{ campaign_phonebbok_active_contact_count }}</td>
            <td class="rounded-foot-right">{{ reached_contact }}</td>
        </tr>

</table>
<br/>-->
<script type="text/javascript">
var jsonData = [
{% for td in total_data %}
   {date:'{{ td.date }}', year:{{ td.year }},day:{{ td.day }}, month:{{ td.month }}, calls:{{ td.count }}, duration:'{{ td.duration__sum|conv_min }}', act:'{{ td.duration__avg|conv_min }}'},
{% endfor %}
];
var callData = [
{% for td in total_data %}
    [{{td.count}} , {{td.starting_date__count}}],
{% endfor %}
];
var durationData = [
{% for td in total_data %}
    [{{td.count}} , {{td.duration__sum}}],
{% endfor %}
];
var summaryData = [
{% for td in total_data %}
    [{{td.count}} , {{td.starting_date__count}}],
{% endfor %}
];

</script>

<script type="text/javascript">
(function($){

    Event.observe(document, 'dom:loaded', function() {

        prettyPrint();

        HumbleFinance.trackFormatter = function (obj) {
            var x = Math.floor(obj.x);
            var data = jsonData[x];
            var text = data.date + " {% trans "Calls :"  %} " + data.calls + " {% trans "Duration :"  %} " + data.duration + " {% trans "ACT :"  %} " + data.act;
            return text;
        };

        HumbleFinance.yTickFormatter = function (n) {

            if (n == this.axes.y.max) {
                return false;
            }
            return n;
        };

        HumbleFinance.xTickFormatter = function (n) {
            if (n == 0) {
                return false;
            }
            x = Math.floor(n)
            var data = jsonData[x].day;
            return data;
        };

        HumbleFinance.init('finance', callData, durationData, summaryData);
      });
})(jQuery);

</script>

{% if total_data %}
<div id="finance" style="position: relative; margin: 40px 0px; width: 800px; border: 1px solid #99CCFF;">
	<div id="labels">
	    <div id="financeTitle">{% trans "Campaign v/s Call Report"  %}</div>
	    <div id="time">
            <a onclick="HumbleFinance.zoom(7);">1 {% trans "week"  %}</a>
	        <a onclick="HumbleFinance.zoom(30);">1 {% trans "month"  %}</a>
            <a onclick="HumbleFinance.zoom(90);">3 {% trans "months"  %}</a>
	        <a onclick="HumbleFinance.zoom(180);">6 {% trans "months"  %}</a>
	        <a onclick="HumbleFinance.zoom(365);">1 {% trans "year"  %}</a>
	    </div>

	    <div id="dateRange"></div>
	</div>
</div>
{% endif %}

<script type="text/javascript">
(function($){
    $(function () {

        /*var data = [
        {% for td in total_data %}
            { label: 'Calls' , data: [[1, {{td.starting_date__count}}]]},
           // { label: 'Duration' , data: [[1, {{td.duration__sum}}]]},
        {% endfor %}
        ];*/
        var data = [
            { label: 'Calls' , data: [[1, {{ total_call_count }}]]},
            { label: 'Duration' , data: [[1, {{ total_duration_sum }}]]},
        ];
        var options = {
                series: {
                    pie: {
                        show: true,
                        radius: 1,
                        label: {
                            show: true,
                            radius: 3/4,
                            formatter: function(label, series){
                                return '<div style="font-size:8pt;text-align:center;padding:2px;color:white;">'+label+'<br/>'+Math.round(series.percent)+'%</div>';
                                }
                            },
                        background: { opacity: 0.5 },
                    }
                },
                legend: {show: false}
        };

        var plot = $.plot($("#camp_pie"), data, options);
    });
})(jQuery);
</script>
    <!--
    {% for td in final_calls %}
            [{{ td.starting_date }},(new Date({{ td.starting_datetime }} * 1000)), {{ td.starting_date__count }}]<br/>
    {% endfor %}-->

    {% if final_calls %}
   <br/> <div id="camp_pie" style="width:300px;height:300px"></div>
    {% endif %}

<script id="source">
var data_count = [
        {% for td in final_calls %}
            [(new Date({{ td.starting_datetime }} * 1000)), {{ td.starting_date__count }}],
        {% endfor %},
    ];
var data_duration = [
    {% for td in final_calls %}
        [(new Date({{ td.starting_datetime }} * 1000)), {{ td.duration__sum }}],
    {% endfor %},
    ];

(function($){
    $(function () {

        function showTooltip(x, y, contents) {
            $('<div id="tooltip">' + contents + '</div>').css( {
                position: 'absolute',
                display: 'none',
                top: y + 5,
                left: x + 5,
                border: '1px solid #fdd',
                padding: '2px',
                'background-color': '#fee',
                opacity: 0.80
            }).appendTo("body").fadeIn(200);
        }


        //alert(data);

        $.plot($("#placeholder"), [
            { label: "Calls",  data: data_count},
            { label: "Duration",  data: data_duration, yaxis: 2},
            ], {
            legend: {
                position: "sw",
                margin: [-150,0],
                labelFormatter: function(label){
                    return '<div class="graph_legend">'+label+'</div>';
                },
            },
            xaxis: {
                mode: "time",
                minTickSize: [1, "{{ select_graph_by }}"],
                max: (new Date({{ max_limit }} * 1000)), // Converting date from Python to Javascript (You have to multiply by 1,000.)
                min: (new Date({{ min_limit }} * 1000)) //Converting date from Python to Javascript
            },
            yaxis: {
                tickSize: 1,
                tickDecimals: 0
            },
            series: {
                lines: { show: true },
                points: { show: true }
            },
            grid: {
                hoverable: true,
                clickable: true,
                backgroundColor: { colors: ["#fff", "#eee"] }
            },
            tooltip: true,
        });

        var previousPoint = null;
        $("#placeholder").bind("plothover", function (event, pos, item) {
            $("#x").text(pos.x.toFixed(2));
            $("#y").text(pos.y.toFixed(2));
            if (item) {

                if (previousPoint != item.dataIndex) {
                    previousPoint = item.dataIndex;

                    $("#tooltip").remove();
                    var x = item.datapoint[0].toFixed(2),
                        y = item.datapoint[1].toFixed(2);
                    //alert(item);
                    function makeArray() {
                    for (i = 0; i<makeArray.arguments.length; i++)
                    this[i + 1] = makeArray.arguments[i];
                    }

                    var months = new makeArray('January','February','March','April','May',
                    'June','July','August','September','October','November','December');
                    var d = new Date(Number(x));
                    var day = d.getDate();
                    var month = d.getMonth() + 1;
                    var yy = d.getYear();
                    var year = (yy < 1000) ? yy + 1900 : yy;


                    var call_date = months[month]+ " " +day + " " + year
                    showTooltip(item.pageX, item.pageY,
                                call_date +  " :  " + Number(y));
                }
            }
            else {
                    $("#tooltip").remove();
                    previousPoint = null;
            }
        });

    });
})(jQuery);
</script>
    {% if final_calls %}
    <br/>
   <div id="placeholder" style="width:600px;height:300px;"></div>
    {% endif %}
{% endblock %}
